#!/bin/bash

## #ddev-generated
## Description: Interactive CLI orchestration tool for Drupal AI workflows
## Usage: drupal-ai [command]
## Example: "ddev drupal-ai setup" or "ddev drupal-ai list"

set -euo pipefail

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIGS_DIR="${DDEV_APPROOT}/.ddev/configs"
SCRIPTS_DIR="${DDEV_APPROOT}/.ddev/scripts"
TEMPLATES_DIR="${DDEV_APPROOT}/.ddev/templates"
CONFIG_FILE="${DDEV_APPROOT}/.ddev/.env.drupal-ai"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Logging functions
log_info() {
    echo -e "${BLUE}â„¹ ${1}${NC}"
}

log_success() {
    echo -e "${GREEN}âœ… ${1}${NC}"
}

log_warning() {
    echo -e "${YELLOW}âš  ${1}${NC}"
}

log_error() {
    echo -e "${RED}âŒ ${1}${NC}"
}

log_step() {
    echo -e "${PURPLE}ðŸ“¦ ${1}${NC}"
}

# Check if yq is available (for YAML parsing)
check_dependencies() {
    if ! command -v yq &> /dev/null; then
        log_error "yq is required but not installed. Installing..."
        if command -v brew &> /dev/null; then
            brew install yq
        else
            log_error "Please install yq manually: https://github.com/mikefarah/yq#install"
            exit 1
        fi
    fi
}

# Load configuration
load_config() {
    if [[ -f "$CONFIG_FILE" ]]; then
        # shellcheck disable=SC1090
        source "$CONFIG_FILE"
    fi
}

# Save configuration
save_config() {
    local key="$1"
    local value="$2"

    if [[ -f "$CONFIG_FILE" ]]; then
        # Update existing key or add new one
        if grep -q "^${key}=" "$CONFIG_FILE"; then
            sed -i.bak "s/^${key}=.*/${key}=${value}/" "$CONFIG_FILE" && rm -f "${CONFIG_FILE}.bak"
        else
            echo "${key}=${value}" >> "$CONFIG_FILE"
        fi
    else
        echo "${key}=${value}" > "$CONFIG_FILE"
    fi
}

# Display available providers
list_providers() {
    log_info "Available AI Providers:"
    if [[ -f "${CONFIGS_DIR}/providers.yaml" ]]; then
        yq eval '.providers | keys | .[]' "${CONFIGS_DIR}/providers.yaml" | while read -r provider; do
            local name=$(yq eval ".providers.${provider}.name" "${CONFIGS_DIR}/providers.yaml")
            local description=$(yq eval ".providers.${provider}.description" "${CONFIGS_DIR}/providers.yaml")
            echo -e "  ${CYAN}${provider}${NC}: ${name} - ${description}"
        done
    else
        log_error "Providers configuration not found"
        exit 1
    fi
}

# Display available functionalities
list_functionalities() {
    log_info "Available AI Functionalities:"
    if [[ -f "${CONFIGS_DIR}/functionalities.yaml" ]]; then
        yq eval '.functionalities | keys | .[]' "${CONFIGS_DIR}/functionalities.yaml" | while read -r functionality; do
            local name=$(yq eval ".functionalities.${functionality}.name" "${CONFIGS_DIR}/functionalities.yaml")
            local description=$(yq eval ".functionalities.${functionality}.description" "${CONFIGS_DIR}/functionalities.yaml")
            echo -e "  ${CYAN}${functionality}${NC}: ${name} - ${description}"
        done
    else
        log_error "Functionalities configuration not found"
        exit 1
    fi
}

# Display installed add-ons
list_installed_addons() {
    log_info "Checking installed add-ons..."

    local addons_found=false

    # Check for pgvector (robertoperuzzo/ddev-pgvector)
    if [[ -f "${DDEV_APPROOT}/.ddev/docker-compose.pgvector.yaml" ]]; then
        echo -e "  ${GREEN}âœ“${NC} pgvector (PostgreSQL with vector extension)"
        addons_found=true
    fi

    # Check for unstructured
    if [[ -f "${DDEV_APPROOT}/.ddev/docker-compose.unstructured.yaml" ]]; then
        echo -e "  ${GREEN}âœ“${NC} unstructured (Document processing)"
        addons_found=true
    fi

    # Check for ollama (stinis87/ddev-ollama)
    if [[ -f "${DDEV_APPROOT}/.ddev/docker-compose.ollama.yaml" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ollama (Local LLM server)"
        addons_found=true
    fi

    # Check for redis
    if [[ -f "${DDEV_APPROOT}/.ddev/docker-compose.redis.yaml" ]]; then
        echo -e "  ${GREEN}âœ“${NC} redis (Cache service)"
        addons_found=true
    fi

    if [[ "$addons_found" == "false" ]]; then
        log_warning "No AI-related add-ons found"
    fi
}

# Interactive provider selection
select_provider() {
    echo -e "\n${PURPLE}ðŸ¤– Drupal AI Setup Wizard${NC}"
    echo "========================"
    echo ""
    echo "Step 1: Select AI Provider"

    if [[ ! -f "${CONFIGS_DIR}/providers.yaml" ]]; then
        log_error "Providers configuration not found"
        exit 1
    fi

    local providers=()
    local provider_keys=()

    while IFS= read -r provider; do
        local name=$(yq eval ".providers.${provider}.name" "${CONFIGS_DIR}/providers.yaml")
        local description=$(yq eval ".providers.${provider}.description" "${CONFIGS_DIR}/providers.yaml")
        providers+=("${name} - ${description}")
        provider_keys+=("${provider}")
    done < <(yq eval '.providers | keys | .[]' "${CONFIGS_DIR}/providers.yaml")

    echo "? Choose your AI provider:"
    select choice in "${providers[@]}"; do
        if [[ -n "$choice" ]]; then
            local selected_index=$((REPLY - 1))
            local selected_provider="${provider_keys[$selected_index]}"
            echo "Selected: $choice"
            echo "$selected_provider"
            return
        fi
    done
}

# Interactive functionality selection
select_functionalities() {
    local provider="$1"
    echo ""
    echo "Step 2: Select Functionality"

    if [[ ! -f "${CONFIGS_DIR}/functionalities.yaml" ]]; then
        log_error "Functionalities configuration not found"
        exit 1
    fi

    log_info "What AI features do you need? (Enter numbers separated by spaces, e.g., '1 2 3')"

    local functionalities=()
    local functionality_keys=()
    local counter=1

    while IFS= read -r functionality; do
        local name=$(yq eval ".functionalities.${functionality}.name" "${CONFIGS_DIR}/functionalities.yaml")
        local description=$(yq eval ".functionalities.${functionality}.description" "${CONFIGS_DIR}/functionalities.yaml")
        echo "  ${counter}. ${name} - ${description}"
        functionalities+=("${name}")
        functionality_keys+=("${functionality}")
        ((counter++))
    done < <(yq eval '.functionalities | keys | .[]' "${CONFIGS_DIR}/functionalities.yaml")

    echo -n "Your selection: "
    read -r selection

    local selected_functionalities=()
    for num in $selection; do
        if [[ "$num" =~ ^[0-9]+$ ]] && [[ "$num" -ge 1 ]] && [[ "$num" -le "${#functionality_keys[@]}" ]]; then
            local index=$((num - 1))
            selected_functionalities+=("${functionality_keys[$index]}")
        fi
    done

    printf '%s\n' "${selected_functionalities[@]}"
}

# Analyze dependencies
analyze_dependencies() {
    local provider="$1"
    shift
    local functionalities=("$@")

    echo ""
    echo "Step 3: Dependencies Analysis"

    if [[ ! -f "${CONFIGS_DIR}/dependencies.yaml" ]]; then
        log_error "Dependencies configuration not found"
        exit 1
    fi

    local required_addons=()

    # Check provider dependencies
    local provider_deps
    provider_deps=$(yq eval ".providers.${provider}.dependencies[]?" "${CONFIGS_DIR}/providers.yaml" 2>/dev/null || echo "")
    if [[ -n "$provider_deps" ]]; then
        while IFS= read -r dep; do
            [[ -n "$dep" ]] && required_addons+=("$dep")
        done <<< "$provider_deps"
    fi

    # Check functionality dependencies
    for functionality in "${functionalities[@]}"; do
        local func_deps
        func_deps=$(yq eval ".functionalities.${functionality}.required_addons[]?" "${CONFIGS_DIR}/functionalities.yaml" 2>/dev/null || echo "")
        if [[ -n "$func_deps" ]]; then
            while IFS= read -r dep; do
                [[ -n "$dep" ]] && required_addons+=("$dep")
            done <<< "$func_deps"
        fi
    done

    # Remove duplicates
    local unique_addons=($(printf "%s\n" "${required_addons[@]}" | sort -u))

    if [[ ${#unique_addons[@]} -gt 0 ]]; then
        log_step "Required add-ons for your selection:"
        for addon in "${unique_addons[@]}"; do
            echo "  - ${addon} â†’ Will install"
        done

        echo ""
        echo -n "? Proceed with installation? (Y/n): "
        read -r proceed
        if [[ "$proceed" =~ ^[Nn] ]]; then
            log_warning "Installation cancelled"
            exit 0
        fi
    else
        log_info "No additional add-ons required"
    fi

    printf '%s\n' "${unique_addons[@]}"
}

# Install add-on
install_addon() {
    local addon_identifier="$1"

    log_step "Installing add-on: ${addon_identifier}..."

    # Use ddev add-on get to install the add-on directly
    if ddev add-on get "$addon_identifier"; then
        log_success "Successfully installed ${addon_identifier}"
        return 0
    else
        log_error "Failed to install ${addon_identifier}"
        return 1
    fi
}

# Configure provider
configure_provider() {
    local provider="$1"

    echo ""
    echo "Step 5: Configuration"

    if [[ ! -f "${CONFIGS_DIR}/providers.yaml" ]]; then
        log_error "Providers configuration not found"
        return 1
    fi

    # Get required variables
    local required_vars
    required_vars=$(yq eval ".providers.${provider}.required_vars[]?" "${CONFIGS_DIR}/providers.yaml" 2>/dev/null || echo "")

    if [[ -n "$required_vars" ]]; then
        while IFS= read -r var; do
            [[ -z "$var" ]] && continue
            echo -n "? ${var}: "
            if [[ "$var" == *"KEY"* ]] || [[ "$var" == *"TOKEN"* ]]; then
                # Secure input for API keys
                read -rs value
                echo ""
            else
                read -r value
            fi
            save_config "$var" "$value"
        done <<< "$required_vars"
    fi

    # Get optional variables with defaults
    local optional_vars
    optional_vars=$(yq eval ".providers.${provider}.optional_vars | to_entries | .[] | \"\(.key):\(.value)\"" "${CONFIGS_DIR}/providers.yaml" 2>/dev/null || echo "")

    if [[ -n "$optional_vars" ]]; then
        while IFS=: read -r var default_value; do
            [[ -z "$var" ]] && continue
            echo -n "? ${var} (${default_value}): "
            read -r value
            save_config "$var" "${value:-$default_value}"
        done <<< "$optional_vars"
    fi
}

# Main setup workflow
setup_workflow() {
    log_info "Starting Drupal AI setup..."

    # Step 1: Select provider
    local provider
    provider=$(select_provider)

    # Step 2: Select functionalities
    local functionalities
    readarray -t functionalities < <(select_functionalities "$provider")

    # Step 3: Analyze dependencies
    local required_addons
    readarray -t required_addons < <(analyze_dependencies "$provider" "${functionalities[@]}")

    # Step 4: Install add-ons
    if [[ ${#required_addons[@]} -gt 0 ]]; then
        echo ""
        echo "Step 4: Installation"
        for addon in "${required_addons[@]}"; do
            install_addon "$addon"
        done
    fi

    # Step 5: Configure provider
    configure_provider "$provider"

    # Save configuration
    save_config "DRUPAL_AI_PROVIDER" "$provider"
    save_config "DRUPAL_AI_FUNCTIONALITIES" "$(IFS=,; echo "${functionalities[*]}")"

    echo ""
    log_success "ðŸŽ‰ Setup Complete!"
    echo ""
    echo "Next steps:"
    echo "- Run \`ddev restart\` to apply changes"
    echo "- Install Drupal AI modules: \`ddev composer require drupal/ai\`"
    echo "- Configure at /admin/config/ai"
}

# List available providers, functionalities and installed add-ons
list_command() {
    echo -e "${PURPLE}ðŸ¤– Drupal AI Status${NC}"
    echo "==================="
    echo ""

    list_providers
    echo ""
    list_functionalities
    echo ""
    list_installed_addons
}

# Display help
show_help() {
    echo -e "${PURPLE}ðŸ¤– Drupal AI Add-on${NC}"
    echo "==================="
    echo ""
    echo "Interactive CLI orchestration tool for Drupal AI workflows"
    echo ""
    echo "Usage: ddev drupal-ai [command]"
    echo ""
    echo "Commands:"
    echo "  setup          Interactive wizard for complete AI stack setup"
    echo "  list           Display available providers and installed add-ons"
    echo "  help           Show this help message"
    echo ""
    echo "Examples:"
    echo "  ddev drupal-ai setup"
    echo "  ddev drupal-ai list"
}

# Main script logic
main() {
    check_dependencies
    load_config

    local command="${1:-help}"

    case "$command" in
        "setup")
            setup_workflow
            ;;
        "list")
            list_command
            ;;
        "help"|"--help"|"-h")
            show_help
            ;;
        *)
            log_error "Unknown command: $command"
            show_help
            exit 1
            ;;
    esac
}

# Run main function with all arguments
main "$@"
